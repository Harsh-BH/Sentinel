# =============================================================================
# Project Sentinel â€” CI Pipeline
# =============================================================================

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  GO_VERSION: "1.22"
  NODE_VERSION: "20"

jobs:
  # ---------- Go API ----------
  lint-api:
    name: Lint API
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          working-directory: api

  test-api:
    name: Test API
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Run tests
        working-directory: api
        run: go test -v -race -coverprofile=coverage.out ./...
      - name: Upload coverage
        if: github.event_name == 'push'
        uses: codecov/codecov-action@v4
        with:
          file: api/coverage.out
          flags: api

  # ---------- Go Worker ----------
  lint-worker:
    name: Lint Worker
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          working-directory: worker

  test-worker:
    name: Test Worker
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Run tests
        working-directory: worker
        run: go test -v -race -coverprofile=coverage.out ./...
      - name: Upload coverage
        if: github.event_name == 'push'
        uses: codecov/codecov-action@v4
        with:
          file: worker/coverage.out
          flags: worker

  # ---------- Frontend ----------
  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      - name: Lint
        working-directory: frontend
        run: npm run lint

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      - name: Build
        working-directory: frontend
        run: npm run build

  # ---------- Integration Tests ----------
  # integration-test:
  #   name: Integration Tests
  #   runs-on: ubuntu-latest
  #   needs: [test-api, test-worker, build-frontend]
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Run integration tests
  #       run: |
  #         docker-compose -f docker-compose.yml up -d postgres rabbitmq redis
  #         sleep 15
  #         ./scripts/integration-test.sh
  #         docker-compose down -v

  # ---------- Docker Build & Push ----------
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test-api, test-worker, build-frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      packages: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build & push API image
        uses: docker/build-push-action@v5
        with:
          context: ./api
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/sentinel-api:latest
      - name: Build & push Worker image
        uses: docker/build-push-action@v5
        with:
          context: ./worker
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/sentinel-worker:latest
      - name: Build & push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/sentinel-frontend:latest
