# =============================================================================
# nsjail configuration for Python 3.12 execution
# Project Sentinel â€” Sandbox Configuration
# =============================================================================
# This is a protobuf text-format config file for nsjail.
# Full reference: https://github.com/google/nsjail/blob/master/config.proto

name: "sentinel-python"
description: "Sandbox for executing untrusted Python 3.12 code"

# Execution mode: ONCE = run a single process and exit
mode: ONCE

# Hostname visible inside the sandbox
hostname: "sandbox"

# Time limit in seconds (overridden by worker CLI args)
time_limit: 5

# Logging
log_level: WARNING

# --- Namespace Isolation ---
clone_newnet: true      # Network namespace (no network access)
clone_newuser: true     # User namespace
clone_newns: true       # Mount namespace (for pivot_root)
clone_newpid: true      # PID namespace
clone_newipc: true      # IPC namespace
clone_newuts: true      # UTS namespace
clone_newcgroup: true   # cgroup namespace

# --- Resource Limits (cgroups v2) ---
cgroup_mem_max: 268435456       # 256 MB
cgroup_pids_max: 64             # Max processes
cgroup_cpu_ms_per_sec: 1000     # 1 CPU core equivalent

# rlimits
rlimit_as_type: HARD
rlimit_cpu_type: HARD
rlimit_fsize: 64                # Max file size in MB
rlimit_nofile: 64               # Max open file descriptors

# --- User Mapping ---
uidmap {
    inside_id: "1000"
    outside_id: ""
    count: 1
}
gidmap {
    inside_id: "1000"
    outside_id: ""
    count: 1
}

# --- Filesystem Mounts ---
# Read-only system directories
mount {
    src: "/usr"
    dst: "/usr"
    is_bind: true
    rw: false
}
mount {
    src: "/lib"
    dst: "/lib"
    is_bind: true
    rw: false
    mandatory: false
}
mount {
    src: "/lib64"
    dst: "/lib64"
    is_bind: true
    rw: false
    mandatory: false
}
mount {
    src: "/bin"
    dst: "/bin"
    is_bind: true
    rw: false
}
mount {
    src: "/etc/alternatives"
    dst: "/etc/alternatives"
    is_bind: true
    rw: false
    mandatory: false
}

# Read-write working directory (user code lives here)
# This is bind-mounted at runtime via --bindmount flag
mount {
    dst: "/tmp"
    fstype: "tmpfs"
    rw: true
}

# /dev/null, /dev/zero, /dev/urandom
mount {
    src: "/dev/null"
    dst: "/dev/null"
    is_bind: true
    rw: false
}
mount {
    src: "/dev/zero"
    dst: "/dev/zero"
    is_bind: true
    rw: false
}
mount {
    src: "/dev/urandom"
    dst: "/dev/urandom"
    is_bind: true
    rw: false
}

# proc filesystem (needed by Python runtime)
mount {
    dst: "/proc"
    fstype: "proc"
    rw: false
}

# Seccomp policy file
# Seccomp policy file (path inside the host, not inside sandbox)
seccomp_policy_file: "/etc/nsjail/policies/python.policy"

# Working directory inside sandbox
cwd: "/tmp/work"

# Disable network
iface_no_lo: true

# Environment variables
envar: "PATH=/usr/local/bin:/usr/bin:/bin"
envar: "HOME=/tmp"
envar: "LANG=en_US.UTF-8"
envar: "PYTHONDONTWRITEBYTECODE=1"
