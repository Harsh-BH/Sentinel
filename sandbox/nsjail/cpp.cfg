# =============================================================================
# nsjail configuration for C++17 compilation and execution
# Project Sentinel â€” Sandbox Configuration
# =============================================================================

name: "sentinel-cpp"
description: "Sandbox for compiling and executing untrusted C++17 code"

mode: ONCE
hostname: "sandbox"
time_limit: 10     # 10s for compilation; overridden to 5s for execution

log_level: WARNING

# --- Namespace Isolation ---
clone_newnet: true
clone_newuser: true
clone_newns: true
clone_newpid: true
clone_newipc: true
clone_newuts: true
clone_newcgroup: true

# --- Resource Limits ---
cgroup_mem_max: 536870912       # 512 MB (more for compilation)
cgroup_pids_max: 128            # More processes for g++ compilation
cgroup_cpu_ms_per_sec: 1000

rlimit_as_type: HARD
rlimit_cpu_type: HARD
rlimit_fsize: 128               # Larger for compiled binaries
rlimit_nofile: 128

# --- User Mapping ---
uidmap {
    inside_id: "1000"
    outside_id: ""
    count: 1
}
gidmap {
    inside_id: "1000"
    outside_id: ""
    count: 1
}

# --- Filesystem Mounts ---
mount {
    src: "/usr"
    dst: "/usr"
    is_bind: true
    rw: false
}
mount {
    src: "/lib"
    dst: "/lib"
    is_bind: true
    rw: false
    mandatory: false
}
mount {
    src: "/lib64"
    dst: "/lib64"
    is_bind: true
    rw: false
    mandatory: false
}
mount {
    src: "/bin"
    dst: "/bin"
    is_bind: true
    rw: false
}
mount {
    src: "/etc/alternatives"
    dst: "/etc/alternatives"
    is_bind: true
    rw: false
    mandatory: false
}
mount {
    dst: "/tmp"
    fstype: "tmpfs"
    rw: true
}
mount {
    src: "/dev/null"
    dst: "/dev/null"
    is_bind: true
    rw: false
}
mount {
    src: "/dev/zero"
    dst: "/dev/zero"
    is_bind: true
    rw: false
}
mount {
    src: "/dev/urandom"
    dst: "/dev/urandom"
    is_bind: true
    rw: false
}
mount {
    dst: "/proc"
    fstype: "proc"
    rw: false
}

seccomp_policy_file: "/etc/nsjail/policies/cpp.policy"

cwd: "/tmp/work"
iface_no_lo: true

envar: "PATH=/usr/local/bin:/usr/bin:/bin"
envar: "HOME=/tmp"
envar: "LANG=en_US.UTF-8"
